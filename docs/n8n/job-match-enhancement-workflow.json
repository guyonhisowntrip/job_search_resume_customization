{
  "name": "Job Match + Resume Enhancement (Gemini)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "job-match-enhancement",
        "responseMode": "lastNode",
        "responseData": "firstEntryJson",
        "options": {}
      },
      "id": "6b8b6b95-9324-4f95-a25d-970c65c0268a",
      "name": "Webhook Job Match",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        260,
        300
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "const incoming = $input.first()?.json ?? {};\nconst body = incoming && typeof incoming.body === \"object\" && incoming.body !== null && !Array.isArray(incoming.body) ? incoming.body : incoming;\nconst headers = incoming && typeof incoming.headers === \"object\" && incoming.headers !== null && !Array.isArray(incoming.headers) ? incoming.headers : {};\n\nconst expectedSecret = $env.N8N_WEBHOOK_SECRET || \"\";\nif (expectedSecret) {\n  const providedSecret = String(headers[\"x-workflow-secret\"] ?? headers[\"X-Workflow-Secret\"] ?? \"\").trim();\n  if (providedSecret !== expectedSecret) {\n    throw new Error(\"Unauthorized request: invalid x-workflow-secret header.\");\n  }\n}\n\nfunction asObject(value) {\n  if (!value || typeof value !== \"object\" || Array.isArray(value)) return {};\n  return value;\n}\n\nfunction toText(value) {\n  if (typeof value === \"string\") return value.trim();\n  if (typeof value === \"number\" || typeof value === \"boolean\") return String(value);\n  return \"\";\n}\n\nfunction toArray(value) {\n  if (Array.isArray(value)) return value.map((item) => toText(item)).filter(Boolean);\n  return [];\n}\n\nfunction clampScore(value) {\n  const numeric = Number.isFinite(value) ? value : 0;\n  const rounded = Math.round(numeric * 10) / 10;\n  return Math.max(0, Math.min(100, rounded));\n}\n\nfunction extractJsonPayload(text) {\n  const fencedJson = text.match(/```json\\\\s*(\\\\{[\\\\s\\\\S]*?\\\\})\\\\s*```/i);\n  const fenced = text.match(/```\\\\s*(\\\\{[\\\\s\\\\S]*?\\\\})\\\\s*```/);\n  const loose = text.match(/(\\\\{[\\\\s\\\\S]*\\\\})/);\n  const candidate = (fencedJson && fencedJson[1]) || (fenced && fenced[1]) || (loose && loose[1]);\n  if (!candidate) {\n    throw new Error(\"No JSON object found in Gemini output.\");\n  }\n  return JSON.parse(candidate);\n}\n\nfunction buildGeminiUrl(configuredBaseUrl, model) {\n  const trimmed = String(configuredBaseUrl || \"\").replace(/\\/$/, \"\");\n  if (!trimmed) {\n    return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent`;\n  }\n  if (trimmed.includes(\"{model}\")) {\n    return trimmed.replace(\"{model}\", model);\n  }\n  if (trimmed.includes(\":generateContent\")) {\n    return trimmed;\n  }\n  if (trimmed.endsWith(\"/models\")) {\n    return `${trimmed}/${model}:generateContent`;\n  }\n  return `${trimmed}/${model}:generateContent`;\n}\n\nconst requestBody = asObject(body);\nconst resumeData = asObject(requestBody.resumeData);\nconst jobDescription = toText(requestBody.jobDescription);\nif (!Object.keys(resumeData).length) {\n  throw new Error(\"resumeData is required.\");\n}\nif (!jobDescription) {\n  throw new Error(\"jobDescription is required.\");\n}\n\nconst apiKey = ($env.LLM_API_KEY || $env.GEMINI_API_KEY || $env.GOOGLE_API_KEY || \"\").trim();\nif (!apiKey) {\n  throw new Error(\"Set LLM_API_KEY (or GEMINI_API_KEY / GOOGLE_API_KEY) in n8n environment.\");\n}\n\nconst model = ($env.LLM_MODEL || \"gemini-1.5-flash\").trim();\nconst baseUrl = ($env.LLM_API_URL || \"https://generativelanguage.googleapis.com/v1beta/models\").trim();\nconst geminiUrl = buildGeminiUrl(baseUrl, model);\n\nconst prompt = [\n  \"You are an expert resume strategist and ATS evaluator.\",\n  \"Evaluate job fit and regenerate a stronger resume while staying truthful.\",\n  \"Return only valid JSON object with keys: originalScore, improvedScore, analysis, improvedResume.\",\n  \"improvedResume must include: personal, contact, links, experience, projects, skills, education.\",\n  \"Scores must be 0..100 and improvedScore >= originalScore.\",\n  \"Do not invent contact details or links.\",\n  \"Keep analysis concise.\",\n  \"\",\n  `Job description:\\n${jobDescription}`,\n  \"\",\n  `Current resume JSON:\\n${JSON.stringify(resumeData)}`\n].join(\"\\n\");\n\nconst response = await fetch(`${geminiUrl}?key=${encodeURIComponent(apiKey)}`, {\n  method: \"POST\",\n  headers: { \"Content-Type\": \"application/json\" },\n  body: JSON.stringify({\n    contents: [{ parts: [{ text: prompt }] }],\n    generationConfig: {\n      temperature: 0,\n      maxOutputTokens: 4096,\n      responseMimeType: \"application/json\"\n    }\n  })\n});\n\nif (!response.ok) {\n  const detail = await response.text();\n  throw new Error(`Gemini call failed (${response.status}): ${detail}`);\n}\n\nconst geminiPayload = await response.json();\nconst parts = geminiPayload?.candidates?.[0]?.content?.parts ?? [];\nconst llmText = Array.isArray(parts) ? parts.map((part) => part?.text || \"\").join(\"\\n\").trim() : \"\";\nif (!llmText) {\n  throw new Error(\"Gemini returned empty content.\");\n}\n\nconst parsed = extractJsonPayload(llmText);\nconst improvedResumeRaw = asObject(parsed.improvedResume);\n\nconst srcPersonal = asObject(resumeData.personal);\nconst srcContact = asObject(resumeData.contact);\nconst srcLinks = asObject(resumeData.links);\n\nconst improvedPersonal = asObject(improvedResumeRaw.personal);\nconst improvedContact = asObject(improvedResumeRaw.contact);\nconst improvedLinks = asObject(improvedResumeRaw.links);\n\nconst improvedResume = {\n  personal: {\n    name: toText(srcPersonal.name) || toText(improvedPersonal.name),\n    title: toText(improvedPersonal.title),\n    summary: toText(improvedPersonal.summary),\n    photo: toText(srcPersonal.photo),\n    primaryPhoto: toText(srcPersonal.primaryPhoto),\n    secondaryPhoto: toText(srcPersonal.secondaryPhoto)\n  },\n  contact: {\n    email: toText(srcContact.email),\n    phone: toText(srcContact.phone),\n    location: toText(srcContact.location)\n  },\n  links: {\n    github: toText(srcLinks.github),\n    linkedin: toText(srcLinks.linkedin),\n    twitter: toText(srcLinks.twitter),\n    portfolio: toText(srcLinks.portfolio)\n  },\n  experience: Array.isArray(improvedResumeRaw.experience)\n    ? improvedResumeRaw.experience.map((entry) => {\n        const item = asObject(entry);\n        return {\n          company: toText(item.company),\n          role: toText(item.role),\n          startDate: toText(item.startDate),\n          endDate: toText(item.endDate),\n          description: toText(item.description)\n        };\n      })\n    : [],\n  projects: Array.isArray(improvedResumeRaw.projects)\n    ? improvedResumeRaw.projects.map((entry) => {\n        const item = asObject(entry);\n        return {\n          name: toText(item.name),\n          description: toText(item.description),\n          tech: toArray(item.tech),\n          link: toText(item.link)\n        };\n      })\n    : [],\n  skills: toArray(improvedResumeRaw.skills),\n  education: toArray(improvedResumeRaw.education)\n};\n\nconst originalScore = clampScore(Number(parsed.originalScore));\nconst improvedScore = clampScore(Math.max(Number(parsed.improvedScore), originalScore));\nconst analysis = toText(parsed.analysis);\n\nreturn [\n  {\n    json: {\n      originalScore,\n      improvedScore,\n      improvedResume,\n      analysis\n    }\n  }\n];"
      },
      "id": "f3f9be16-bb2f-475b-b3f5-8f93c213d73c",
      "name": "AI Job Match + Enhancement",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        300
      ]
    }
  ],
  "connections": {
    "Webhook Job Match": {
      "main": [
        [
          {
            "node": "AI Job Match + Enhancement",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "20366046-34bf-4a98-a17c-f2949448b7c5",
  "meta": {
    "templateCredsSetupCompleted": false
  },
  "id": "aCrmZ5rNce2Skf9f",
  "tags": []
}
